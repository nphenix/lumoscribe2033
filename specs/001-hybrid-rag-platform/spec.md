# 功能规范: Hybrid Graph-RAG Phase 1 质量平台

**功能分支**: `001-hybrid-rag-platform`
**创建时间**: 2025-11-14
**状态**: 进行中
**输入**: 用户描述: "此项目是个大型Hybrid Graph-RAG 项目旨在为以个人为主题的使用者构建一套可以连接llm的知识工具平台，以便良好的解决人与AI交互的问题，知识存储，生成，使用的问题，我们将分阶段规划，开发，第一阶段的内容是开发一套基于spec kit的vibe coding质量提升平台，主要内容包括：1、用来降低spec kit使用难度的标准流程管线，用户提交一个用自然语言描述的txt或md文档即可完成/speckit.constitution，/speckit.specify，/speckit.plan，/speckit.tasks的全部流程；2、自动化匹配多个IDE开发工具的链接（如cursor,roocode等），保证IDE开发工具能够遵循speckit的规范；3、对于项目中的文档根据用户自动分为三类，面向agents使用的文档，应遵循最佳提示词实践，并且考虑tokens消耗，精准简短，面向开发者使用的过程文档应该专业，清晰，简介，面向外部使用这提供的文档应该，专业，完整，全面，结构清晰，格式严谨样式美观；4、应建立最佳实践库协助开发者和对接的大语言模型完善自动生成的speckit内容；5、提供全面的代码，文档静态检查功能，确保不发生常规性错误，满足项目定义的spec kit规则；6、建立AI对话存储库（至少包括cursor,roocode的对话内容自动检索，增量更新，手动导入txt或md格式的对话内容（需标注来源）），AI 对话关联：提交前校验是否关联至对应对话记录（通过对话 ID/来源标签），方便问题追踪，可以检索历史与AI交互的对话内容，在做静态检查发现问题可以追溯是哪段对话造成的问题；7、合规/流程检查：PR 模板或 CI 步骤验证：是否引用了对应 specs/<feature>、相关章程原则、文档更新记录，speckit 流程守卫：自动检查 spec.md / plan.md / tasks.md 是否同步更新，并且带有章程里的生成标签资料分类器：检测文档是否标记为 Agent/Dev/External，且内容长度、格式满足要求（例如 Agent 文档 token 上限、外部文档需要标题/目录），文档与项目状态匹配程度，确保文档不脱节项目进度和实现的代码；8、代码准确性 / 质量，Spec-to-Code Traceability：在任务或 PR 中自动比对需求 ID vs. 提交文件，避免漏实现。"

> 范围说明: Phase 1 仅负责 speckit 工件的导入/初始化以及事后静态检查与追溯, 不直接介入具体功能开发或代码实现。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 一键生成 speckit 全流程 (优先级: P1)

运营人员或项目负责人上传一份自然语言 txt/md 文档, 系统自动解析并串行调用 `/speckit.constitution → /speckit.specify → /speckit.plan → /speckit.tasks`, 输出完整的 speckit 工件并汇总生成日志。

**优先级原因**: 该能力是 Phase 1 的核心价值, 直接降低 speckit 入门门槛, 没有它就无法交付其余功能。

**独立测试**: 准备一份示例需求文档, 上传后检查 speckit 四个产物是否全部生成、带有章程标签且路径正确, 并验证错误日志可读。

**验收场景**: 

1. **给定** 用户提供一份自然语言文档, **当** 触发标准流程管线, **那么** 系统应生成 constitution/spec/plan/tasks 并返回包含校验记录的摘要。
2. **给定** speckit 命令执行失败, **当** 管线捕获错误, **那么** 系统应输出可定位的错误信息并供用户重试。

---

### 用户故事 2 - IDE 适配工件生成 (优先级: P1)

平台在项目根目录下自动生成各 IDE 需要的 speckit 静态文件与目录结构(如 `.cursor/commands`, `.roo/commands`, `agents.md` 等), 并保持可被 IDE 平台自动调用。

**优先级原因**: 通过自动生成适配工件, 可确保不同 IDE 在同一仓库中遵循一致的 speckit 规则, 避免人工配置误差。

**独立测试**: 针对每个受支持 IDE 运行生成命令, 检查静态文件内容、路径和引用章程原则; 在 IDE 中加载这些文件, 验证其能正确触发 speckit 流程或守卫。

**验收场景**: 

1. **给定** 需要支持新的 IDE, **当** 平台执行适配生成, **那么** 必须在仓库中落地对应的命令/提示文件并通过校验脚本。
2. **给定** IDE 调用生成的静态文件, **当** 开发者触发 speckit 操作, **那么** 平台需确保引用的章程与文档路径正确无误。

---

### 用户故事 3 - 文档三分法评估 (优先级: P2)

平台对项目中已生成的 speckit 文档与附属资料进行自动抽样与评估, 将其标记为 Agent/Developer/External, 并依据分类校验风格、结构与(仅针对 Agent 文档的)token 消耗, 输出整改项。

**优先级原因**: 保证现有文档体系始终与章程一致, 防止 speckit 工件在多次迭代后偏离既定风格。

**独立测试**: 准备已落地的三类文档, 运行评估任务, 检查分类标记、格式评分及针对 Agent 文档的 token 报告, 确认整改建议可追踪到文件路径。

**验收场景**: 

1. **给定** 仓库中存在一组 speckit 工件, **当** 平台运行评估, **那么** 应输出分类结果、结构评分以及针对 Agent 文档的 token 建议。
2. **给定** 评估发现 Developer 或 External 文档格式缺失, **当** 审阅者查看整改项, **那么** 可直接跳转到原文件位置完成修订。

---

### 用户故事 4 - 最佳实践与对话溯源 (优先级: P2)

平台需要维护可扩展的最佳实践库和 AI 对话存储, 利用向量库与知识图谱对大量对话进行检索; 至少支持从 Cursor、RooCode 等工具的默认存储目录自动导入静态文件(无需手动上传), 并兼容不同格式。静态检查产生的告警应能追溯到相关对话与实践条目。

**优先级原因**: 只有建立高质量的溯源体系, speckit 自动生成结果与静态检查才具备可解释性, 对长期治理至关重要。

**独立测试**: 准备来自多种 IDE 的对话文件, 通过目录扫描导入, 在向量检索中验证基于主题/任务的查询结果, 并确认告警报告引用正确的对话片段。

**验收场景**: 

1. **给定** RooCode 在固定目录生成的对话日志, **当** 平台执行导入, **那么** 应自动识别格式、生成来源标签并写入向量库/知识图谱。
2. **给定** 静态检查发现 Spec-to-Code 不一致, **当** 审阅者查看详情, **那么** 可看到导致该问题的对话、相关最佳实践以及建议的修复提示。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 平台必须接受自然语言 txt/md 文档, 并串行执行 speckit 四大命令, 输出可下载工件及完整执行/校验日志。
- **FR-002**: 管线需在每个 speckit 步骤后校验生成文件路径、章节完整性与章程标签, 失败时提供可重试的上下文。
- **FR-003**: 系统必须支持为至少 Cursor、RooCode 等 IDE 生成静态适配包(命令、提示、agents 文件), 并提供校验脚本保证结构正确。
- **FR-004**: 文档分类评估仅对 Agent 文档执行 token/长度校验, 但需对三类文档输出风格与结构整改建议。
- **FR-005**: 平台应提供最佳实践库, 支持按场景、章程原则或 speckit 步骤检索, 并可在 speckit 生成过程中引用示例。
- **FR-006**: 必须实现代码与文档的静态检查中心, 包含 speckit 规则、章程约束、文件长度、目录规范、中文语种校验。
- **FR-007**: 系统需维护 AI 对话存储库, 支持从固定目录自动导入或手动上传带来源标签的文件, 并统一转换为可在向量库/知识图谱中检索的格式。
- **FR-008**: 静态检查告警必须能够关联到特定对话 ID、最佳实践条目与 speckit 任务, 以便追溯问题来源。
- **FR-009**: PR 模板/CI 流程必须验证是否引用对应 `specs/<feature>`、说明受影响章程、列出文档更新记录, 未满足则阻止合并。
- **FR-010**: 平台应提供 Spec-to-Code Traceability 报告, 自动比对任务 ID 与提交文件, 标记遗漏的需求覆盖。

### 关键实体 *(如果功能涉及数据则包含)*

- **SubmissionPackage**: 用户上传的自然语言文档及元数据(作者、时间、语言), 触发 speckit 流程并记录执行状态。
- **IDESupportPackage**: 为每个 IDE 生成的静态文件集合(命令、agents、提示), 包含版本、适用章程与校验结果。
- **DocumentProfile**: 存储文档分类(A/D/E)、结构评分、整改建议以及针对 Agent 文档的 token 报告。
- **BestPracticeArtifact**: 由专家或 LLM 产出的提示、流程模板或案例, 标注适用场景与引用要求(不按模型划分)。
- **ConversationRecord**: 从 Cursor、RooCode 默认目录或手动导入的对话, 带有来源标签、时间戳、关联 speckit 任务和向量索引。
- **VectorKnowledgeStore**: 结合向量库与知识图谱的索引结构, 存储对话语义嵌入、关系以及最佳实践引用。
- **ComplianceReport**: 静态检查输出, 记录每次流程的规则校验结果、关联对话与整改任务。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 95% 的自然语言输入可成功生成完整 speckit 工件, 且每次执行都附带可复现的校验日志。
- **SC-002**: 支持的 IDE 均能在一次生成后获得最新的适配包, 100% 的 IDE 校验脚本通过。
- **SC-003**: 文档分类准确率 ≥98%(以人工抽样为准), Agent 文档 token 使用较初始版本平均降低 30%, Developer/External 文档结构评分 ≥90/100。
- **SC-004**: 静态检查在 CI 中拦截 ≥99% 违反 speckit 规则或文档未更新的提交; Spec-to-Code Traceability 检查覆盖率达到 100%。
- **SC-005**: AI 对话检索在语义召回上达到 ≥95% 的相关性评分, 且 100% 的严重告警能定位到至少一条对话或最佳实践引用。
