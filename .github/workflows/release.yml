# GitHub 发布 Workflow
# 用于自动化版本发布流程

name: Release

on:
  push:
    tags:
      - 'v*'  # 触发所有以 'v' 开头的标签
  
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: v0.1.0)'
        required: true
        type: string
      release_type:
        description: '发布类型'
        required: true
        default: 'patch'
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'
      prerelease:
        description: '是否为预发布'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 作业 1: 版本验证和准备
  prepare-release:
    name: 📋 准备发布
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install bumpversion git-changelog-builder
      
      - name: 🔍 获取版本信息
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            # 从标签提取版本号
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
            PRERELEASE="false"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "🔍 版本信息："
          echo "  版本: $VERSION"
          echo "  标签: v$VERSION"
          echo "  预发布: $PRERELEASE"
      
      - name: 📋 生成变更日志
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # 生成变更日志
          CHANGELOG=$(git-changelog -o markdown -t "v$VERSION" || echo "## v$VERSION ($(date +%Y-%m-%d))\n\n### 新增功能\n- 技术栈预览版发布\n\n### 修复内容\n- 完善基础架构和文档\n\n### 其他改进\n- 优化开发体验")
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ✅ 验证版本格式
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # 验证版本格式 (语义化版本)
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ 版本格式无效: $VERSION"
            echo "请使用语义化版本格式，例如: 0.1.0, 0.1.1, 0.2.0, 1.0.0"
            exit 1
          fi
          
          echo "✅ 版本格式验证通过: $VERSION"
      
      - name: 🔍 检查版本是否已存在
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "❌ 版本已存在: $TAG"
            exit 1
          fi
          
          echo "✅ 版本检查通过: $TAG"
      
      - name: 📊 收集发布信息
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## 发布准备信息" >> $GITHUB_STEP_SUMMARY
          echo "- **版本**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **类型**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # 作业 2: 代码质量检查
  code-quality:
    name: 🔍 代码质量检查
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: 📦 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install ruff mypy pytest pytest-cov
          pip install -r requirements-dev.txt
      
      - name: 🔍 Ruff 代码检查
        run: |
          echo "🔍 运行 Ruff 代码质量检查..."
          ruff check src/ --output-format=github
      
      - name: 🔍 MyPy 类型检查
        run: |
          echo "🔍 运行 MyPy 类型检查..."
          mypy src/ --ignore-missing-imports
      
      - name: 🧪 运行测试套件
        run: |
          echo "🧪 运行测试套件..."
          pytest tests/ -v --tb=short --cov=src --cov-report=xml --cov-report=html
      
      - name: 📊 上传覆盖率报告
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: 🔍 安全扫描
        run: |
          echo "🔍 运行安全扫描..."
          pip install safety bandit
          safety check
          bandit -r src/ -f json -o bandit-report.json || true

  # 作业 3: 构建和打包
  build-package:
    name: 📦 构建包
    runs-on: ubuntu-latest
    needs: code-quality
    outputs:
      package-path: ${{ steps.build.outputs.package-path }}
      wheel-path: ${{ steps.build.outputs.wheel-path }}
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 📦 安装构建依赖
        run: |
          python -m pip install --upgrade pip build wheel setuptools
      
      - name: 🏗️ 构建包
        id: build
        run: |
          echo "🏗️ 构建 Python 包..."
          python -m build
          
          # 获取构建产物路径
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          SDIST_FILE=$(ls dist/*.tar.gz | head -1)
          
          echo "wheel-path=$WHEEL_FILE" >> $GITHUB_OUTPUT
          echo "package-path=$SDIST_FILE" >> $GITHUB_OUTPUT
          
          echo "📦 构建完成:"
          echo "  Wheel: $WHEEL_FILE"
          echo "  Source: $SDIST_FILE"
      
      - name: 📋 验证包
        run: |
          echo "📋 验证构建包..."
          pip install ${{ steps.build.outputs.wheel-path }}
          
          # 测试导入
          python -c "import lumoscribe2033; print('✅ 包导入成功')"
          python -c "from src.api.main import app; print('✅ API 导入成功')"
          python -c "from src.cli.main import app; print('✅ CLI 导入成功')"
      
      - name: 📦 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: python-package
          path: dist/
          retention-days: 30

  # 作业 4: 创建发布
  create-release:
    name: 🚀 创建发布
    runs-on: ubuntu-latest
    needs: [prepare-release, code-quality, build-package]
    permissions:
      contents: write
      id-token: write  # 用于发布到 GitHub Container Registry
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 📦 下载构建产物
        uses: actions/download-artifact@v3
        with:
          name: python-package
          path: dist/
      
      - name: 🚀 创建 GitHub 发布
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: "lumoscribe2033 v${{ needs.prepare-release.outputs.version }} - 技术栈预览版"
          body: |
            ${{ needs.prepare-release.outputs.changelog }}
            
            ## 📦 下载链接
            
            - **源代码**: [lumoscribe2033-${{ needs.prepare-release.outputs.version }}.tar.gz](https://github.com/lumoscribe2033/lumoscribe2033/releases/download/${{ needs.prepare-release.outputs.tag }}/lumoscribe2033-${{ needs.prepare-release.outputs.version }}.tar.gz)
            - **Python Wheel**: [lumoscribe2033-${{ needs.prepare-release.outputs.version }}-py3-none-any.whl](https://github.com/lumoscribe2033/lumoscribe2033/releases/download/${{ needs.prepare-release.outputs.tag }}/lumoscribe2033-${{ needs.prepare-release.outputs.version }}-py3-none-any.whl)
            
            ## 🛠️ 安装方法
            
            ```bash
            # 从 GitHub Releases 安装
            pip install https://github.com/lumoscribe2033/lumoscribe2033/releases/download/${{ needs.prepare-release.outputs.tag }}/lumoscribe2033-${{ needs.prepare-release.outputs.version }}-py3-none-any.whl
            
            # 或下载后本地安装
            pip install lumoscribe2033-${{ needs.prepare-release.outputs.version }}-py3-none-any.whl
            ```
            
            ## 🔗 相关链接
            
            - [项目文档](https://github.com/lumoscribe2033/lumoscribe2033#readme)
            - [快速开始](https://github.com/lumoscribe2033/lumoscribe2033/blob/main/specs/001-hybrid-rag-platform/quickstart.md)
            - [贡献指南](https://github.com/lumoscribe2033/lumoscribe2033/blob/main/CONTRIBUTING.md)
            
            ## 📊 发布信息
            
            - **发布类型**: 技术栈预览版
            - **支持平台**: Windows 11
            - **Python 版本**: 3.12+
            - **许可证**: Apache 2.0
            
            ---
            
            **注意**: 这是一个技术栈预览版，主要用于展示项目的基础架构和技术能力。功能特性将在后续版本中逐步完善。
          prerelease: ${{ needs.prepare-release.outputs.prerelease }}
          files: |
            dist/*.whl
            dist/*.tar.gz
          generate_release_notes: false
      
      - name: 📋 更新发布摘要
        run: |
          echo "## 🚀 发布成功" >> $GITHUB_STEP_SUMMARY
          echo "- **版本**: ${{ needs.prepare-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **发布链接**: https://github.com/lumoscribe2033/lumoscribe2033/releases/tag/${{ needs.prepare-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **包文件**: 已上传到发布页面" >> $GITHUB_STEP_SUMMARY
          echo "- **发布类型**: ${{ needs.prepare-release.outputs.prerelease == 'true' && '预发布' || '正式发布' }}" >> $GITHUB_STEP_SUMMARY

  # 作业 5: 发布后通知
  post-release:
    name: 📬 发布后通知
    runs-on: ubuntu-latest
    needs: create-release
    if: always()
    
    steps:
      - name: 📬 发送通知
        run: |
          echo "## 🎉 发布完成" >> $GITHUB_STEP_SUMMARY
          echo "lumoscribe2033 v${{ needs.prepare-release.outputs.version }} 已成功发布！" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**下一步操作建议：**" >> $GITHUB_STEP_SUMMARY
          echo "1. 📖 更新项目文档中的版本信息" >> $GITHUB_STEP_SUMMARY
          echo "2. 📧 通过邮件通知相关用户" >> $GITHUB_STEP_SUMMARY
          echo "3. 📱 在社交媒体上宣传新版本" >> $GITHUB_STEP_SUMMARY
          echo "4. 📝 记录发布日志到 docs/internal/logs.md" >> $GITHUB_STEP_SUMMARY
          
          # 如果需要，可以在这里添加邮件通知、微信通知等